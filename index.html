<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待取名</title>
</head>

<body class="login-img">
    <div class="login-box" id="login-box">
        <div class="login-p">
            <p style="color: white; font-size: 60px; margin: 25px 0 0 0;">Welcome</p>
        </div>
        <div class="login-form">
            <input type="text" placeholder="Username" class="login-input" id="username">
            <button class="login-btn" id="login-btn">Login</button>
        </div>
    </div>

    <!-- 动态加载的内容区域 -->
    <div id="content-box" style="display: none;height: 75%;width: 70%;background-color: white;border-radius: 5px;">
        <h1 style="margin-bottom: 3px;text-align: center;height: 60px;box-shadow: 0px 3px 0 0 rgb(236 230 230);">
            Welcome, <span id="welcome-username"></span>!</h1>
        <div id="content">
            <div class="Threads">
                <div class="Threads" id="threads-container">
                    <!-- 动态生成的 Threads-p 容器 -->
                </div>
                <div class="publish-btn-blue">
                    <svg t="1728421761271" class="icon" style="margin-right: 3px;" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="4614" width="26" height="26">
                        <path
                            d="M350.912 605.376l-299.968-182.72 908.48-355.648-159.072 818.272-387.04-247.872L759.264 263.936zM416 704v209.92l128.256-130.208z"
                            fill="#ffffff" p-id="4615"></path>
                    </svg>
                </div>
            </div>
            <!-- 帖子详情 -->
            <div id="thread-details" class="details">
                <div id="thread-id">
                    <div>
                        <h2 id="thread-title"></h2>
                        <p id="thread-user" style="text-align: end;"></p>
                    </div>
                    <div>
                        <ul id="thread-posts"></ul>
                    </div>
                </div>
                <div style="height: 50px;display: flex;justify-content: space-around;">
                    <input type="text" placeholder="My reply" class="content-input" id="Send">
                    <button class="buttonClass1" id="Send-button">Send</button>
                    <button class="buttonClass2" id="close-button">Close</button>
                </div>
            </div>

            <!-- 发布页 -->
            <div id="publish" class="publish">
                <div style="display: flex;justify-content: space-between;height: 60px;width: 100%;">
                    <input type="text" placeholder="Icon" style="width: 50px;height: 50px;font-size: 20px;"></input>
                    <input type="text" placeholder="thread_title"
                        style="width: calc(100% - 80px);height: 50px;font-size: 20px;"></input>
                </div>
                <div style="width: 100%; height: calc(100% - 150px); display: flex;">
                    <textarea placeholder="text"
                        style="width: 100%; font-size: 20px; padding: 10px; box-sizing: border-box; overflow-wrap: break-word;"></textarea>
                </div>
                <div>
                    <p style="text-align: end;"></p>
                </div>
                <div style="height: 50px;width: 100%;margin-top: 5px;">
                    <button class="buttonClass1" id="publish-button">publish</button>
                    <button class="buttonClass2" id="close-publish-button">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>

<style>
    body {
        margin: 0;
    }

    .login-img {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background: url("./img/login.gif");
        background-size: cover;
        background-position: center;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .login-box {
        width: 30%;
        min-width: 300px;
        height: 30%;
        border-radius: 25px;
        border: 1px solid black;
        background-color: #ffffff1a !important;
        backdrop-filter: blur(5px);
    }

    .login-p {
        height: 30%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .login-form {
        height: 70%;
        display: flex;
        align-items: center;
        flex-direction: column;
        justify-content: space-evenly;
    }

    .login-input {
        width: 50%;
        height: 40px;
        border-radius: 5px;
    }

    .login-input:focus {
        outline: none;
    }

    input:focus {
        outline: none;
    }

    .login-btn {
        width: 20%;
        height: 30px;
        border-radius: 25px;
        background-color: rgb(181, 145, 85);
    }

    #content {
        text-align: center;
        height: calc(100% - 85px);
    }

    .Threads {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        border-radius: 0px;
        background: #ededed;
        box-shadow: inset 35px 35px 70px #e1e1e1,
            inset -35px -35px 70px #f9f9f9;
        position: relative;
        /* 添加相对定位 */
        overflow-y: auto;
        /* 添加垂直滚动条 */
    }

    .Threads-p {
        width: 96%;
        height: 35px;
        min-height: 35px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 5px;
        margin-top: 5px;
        padding: 0 13px;
        background: rgb(238, 174, 202);
        background: radial-gradient(circle, rgba(238, 174, 202, 1) 0%, rgba(120, 175, 240, 1) 100%);
    }

    .Threads-p p {
        margin: 0;
    }

    .publish-btn-blue {
        position: absolute;
        /* 绝对定位 */
        bottom: 10px;
        /* 距离底部 10px */
        right: 10px;
        /* 距离右侧 10px */
        width: 50px;
        height: 50px;
        background-color: #0096ff;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .details {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50%;
        height: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 1px solid black;
        border-radius: 5px;
        background: rgb(174, 186, 238);
        background: radial-gradient(circle, rgba(174, 186, 238, 1) 0%, rgba(120, 240, 152, 0.989233193277311) 100%);
    }

    .details-show {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    #thread-posts {
        padding: 0;
    }

    #thread-posts li {
        font-size: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-decoration: none;
        /* 默认无下划线 */
    }

    #thread-posts li:hover {
        text-decoration: underline;
        /* 鼠标悬停时显示下划线 */
    }

    .post-text {
        text-align: left;
    }

    .post-user {
        text-align: right;
    }

    /* 设置图片样式 */
    .post-image {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-right: 8px;
    }

    /* 提交按钮 */

    .buttonClass1 {
        font-size: 15px;
        font-family: Arial;
        width: 80px;
        height: 50px;
        border-width: 1px;
        color: #fff;
        border-color: #566963;
        font-weight: bold;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
        box-shadow: inset 0px 1px 3px 0px #91b8b3;
        text-shadow: inset 0px -1px 0px #2b665e;
        background: linear-gradient(rgba(38, 218, 172, 1), rgba(16, 235, 121, 1));
    }

    .buttonClass1:hover {
        background: linear-gradient(rgba(16, 235, 121, 1), rgba(38, 218, 172, 1));
    }

    /* 退出按钮 */
    .buttonClass2 {
        font-size: 15px;
        font-family: Arial;
        width: 80px;
        height: 50px;
        border-width: 1px;
        color: #fff;
        border-color: #566963;
        font-weight: bold;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
        box-shadow: inset 0px 1px 3px 0px #91b8b3;
        text-shadow: inset 0px -1px 0px #2b665e;
        background: linear-gradient(#768d87, #6c7c7c);
    }

    .buttonClass2:hover {
        background: linear-gradient(#6c7c7c, #768d87);
    }

    /* 发送框 */
    .content-input {
        font-size: 20px;
        margin: 0;
        width: calc(100% - 200px);
        height: 45px;
    }

    .content-input:focus {
        outline: none;
    }

    /* 发布页 */
    .publish {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50%;
        height: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 1px solid black;
        border-radius: 5px;
        background: rgb(174, 212, 238);
        background: radial-gradient(circle, rgba(174, 212, 238, 1) 0%, rgba(120, 207, 240, 0.989233193277311) 18%);
    }

    /* 发布页输入口 */
    /* 取消选中时的样式 */
    textarea:focus {
        outline: none;
        /* 取消聚焦时的外框 */
    }

    /* 设置textarea的样式 */
    textarea {
        width: 100%;
        font-size: 20px;
        padding: 10px;
        box-sizing: border-box;
        overflow-wrap: break-word;
        white-space: pre-wrap;
        word-wrap: break-word;
        resize: none;
        /* 禁止调整大小 */
        border: 1px solid #ccc;
        /* 可根据需要设置边框样式 */
    }
</style>

<script>
    // 给登录按钮添加点击事件监听器
    document.getElementById('login-btn').addEventListener('click', function () {
        // 获取输入框中的用户名
        const username = document.getElementById('username').value;

        // 发起 HTTP 请求检查用户名是否存在
        fetch('http://localhost:7777/api/users')
            // 将响应体中的 JSON 数据解析为 JavaScript 对象
            .then(response => response.json())
            .then(data => {
                // 查找与输入用户名匹配的用户对象
                const user = data.find(user => user.username === username);

                if (user) {
                    // 更新浏览器历史记录
                    history.pushState({ username: user.username }, 'Index Page', `?username=${encodeURIComponent(user.username)}`);

                    // 显示内容并隐藏登录框，传入用户的全名
                    showContent(user.name);
                } else {
                    // 用户名不存在时提示错误
                    alert('Invalid username');
                }
            })
            .catch(error => {
                // 捕获请求错误并提示
                console.error('Error fetching data:', error);
                alert('An error occurred while fetching data');
            });
    });

    // 显示内容并隐藏登录框
    function showContent(username) {
        // 确认元素存在再设置文本
        const welcomeUsernameElement = document.getElementById('welcome-username');
        if (welcomeUsernameElement) {
            welcomeUsernameElement.textContent = username;
        }
        fetchThreadsData();

        // 显示内容框
        document.getElementById('content-box').style.display = 'block';

        // 隐藏登录框
        document.getElementById('login-box').style.display = 'none';
    }

    // 隐藏内容并显示登录框
    function hideContent() {
        // 隐藏内容框
        document.getElementById('content-box').style.display = 'none';

        // 显示登录框
        document.getElementById('login-box').style.display = 'block';
    }

    // 监听浏览器历史记录的变化
    window.onpopstate = function (event) {
        const state = event.state;
        if (state && state.username) {
            // 显示内容
            showContent(state.username);
        } else {
            // 隐藏内容
            hideContent();
        }
    };

    // 清除 URL 中的查询参数
    function clearURLParams() {
        history.replaceState({}, document.title, window.location.pathname);
    }

    // 页面加载时处理 URL 参数
    const urlParams = new URLSearchParams(window.location.search);
    const usernameFromURL = urlParams.get('username');

    if (usernameFromURL) {
        // 发起 HTTP 请求查找对应用户的 name
        fetch('http://localhost:7777/api/users')
            .then(response => response.json())
            .then(data => {
                // 查找与输入用户名匹配的用户对象
                const user = data.find(user => user.username === usernameFromURL);

                if (user) {
                    // 显示内容
                    showContent(user.name);
                } else {
                    // 隐藏内容
                    hideContent();
                    // 清除 URL 中的查询参数
                    clearURLParams();
                }
            })
    } else {
        // 隐藏内容
        hideContent();
    }

    // 当前线程 ID
    let currentThreadId;

    function fetchThreadsData() {
        fetch('http://localhost:7777/api/threads')
            .then(response => response.json())
            .then(data => {
                const threadsContainer = document.getElementById('threads-container');
                threadsContainer.innerHTML = ''; // 清空现有内容

                data.forEach(thread => {
                    const threadDiv = document.createElement('div');
                    threadDiv.className = 'Threads-p';
                    threadDiv.id = thread.id;

                    const threadTitle = document.createElement('p');
                    threadTitle.textContent = `${thread.icon} ${thread.thread_title}`;
                    threadTitle.style.margin = '0 0 2px 0'; // 设置 p 标签的 margin

                    const threadUser = document.createElement('p');
                    threadUser.textContent = `By: ${thread.user}`;
                    threadUser.style.margin = '0'; // 设置 p 标签的 margin

                    threadDiv.appendChild(threadTitle);
                    threadDiv.appendChild(threadUser);
                    threadsContainer.appendChild(threadDiv);

                    // 添加点击事件
                    threadDiv.addEventListener('click', function () {
                        const threadId = this.id;
                        fetchThreadDetails(threadId);
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching threads data:', error);
                alert('An error occurred while fetching threads data');
            });
    }

    // 展开对应的帖子
    function fetchThreadDetails(threadId) {
        fetch(`http://localhost:7777/api/threads/${threadId}`)
            .then(response => response.json())
            .then(data => {
                // 展示详细数据
                showThreadDetails(data);

                // 更新当前线程 ID
                currentThreadId = threadId;
            })
    }

    // 显示详细数据
    function showThreadDetails(data) {
        // 显示详细数据
        // 标题
        document.getElementById('thread-title').textContent = `${data.icon} ${data.thread_title}`;
        // 用户
        document.getElementById('thread-user').textContent = `By: ${data.user}`;

        const threadPosts = document.getElementById('thread-posts');
        threadPosts.innerHTML = ''; // 清空现有内容

        data.posts.forEach(post => {
            const postItem = document.createElement('li');
            postItem.innerHTML = `
            <div style="display: flex; align-items: center;">
            <img src="./img/recommend.png" alt="Recommend" class="post-image">
            <span class="post-text">${post.text}</span></div>
            <span class="post-user">- ${post.user}</span>
        `;
            threadPosts.appendChild(postItem);
        });

        // 显示弹出窗口并添加 .details-show 类
        document.getElementById('thread-details').classList.add('details-show');
    }

    // 关闭按钮点击事件
    document.getElementById('close-button').addEventListener('click', function () {
        // 移除 .details-show 类
        document.getElementById('thread-details').classList.remove('details-show');
    });

    document.getElementById('Send-button').addEventListener('click', function () {
        sendReply(currentThreadId);
    });

    // 获取当前页面的 URL
    const currentUrl = new URL(window.location.href);

    // 创建 URLSearchParams 对象
    const queryParams = new URLSearchParams(currentUrl.search);

    // 获取 username 参数
    const username = queryParams.get('username');
    if (username) {
        // 存储到全局变量
        window.globalUsername = username;
    }

    // 当页面完全加载后执行====发布页的名称
    window.onload = function () {
        // 获取从 URL 参数或登录表单中获取到的用户名
        const username = window.globalUsername || 'DefaultUsername';

        // 更新包含用户名的 <p> 标签的内容
        const usernameParagraph = document.querySelector('.publish p');
        if (usernameParagraph) {
            usernameParagraph.textContent = `- ${username}`;
        }
    };

    // 发送回复的文本
    function sendReply(currentThreadId) {
        // 获取回复文本
        const replyText = document.getElementById('Send').value.trim();
        if (!replyText) {
            alert('Please enter a reply message.');
            return;
        }

        // 使用全局变量作为用户名
        const user = window.globalUsername || 'DefaultUsername';

        // 拼接 URL 并发送 POST 请求
        fetch(`http://localhost:7777/api/threads/${currentThreadId}/posts`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: replyText,
                user: user // 使用全局变量或默认用户名
            })
        })
            .then(response => response.json())
            .then(data => {
                // 处理回复成功
                console.log('Reply sent successfully:', data);

                // 清空输入框
                document.getElementById('Send').value = '';

                // 刷新帖子列表
                fetchThreadDetails(currentThreadId);
            })
            .catch(error => {
                // 处理错误情况
                console.error('Error sending reply:', error);
                alert('An error occurred while sending your reply.');
            });
    }
</script>

</html>